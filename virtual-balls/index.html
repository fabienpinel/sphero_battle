<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
</head>
<body onload="init()">

<button onclick="login()">login</button>
<button onclick="logout()">logout</button>
<br>

<canvas id="demoCanvas" width="500" height="500" style="border:5px black solid;"></canvas>

<script>
    function getAjax () {
        if (window.XMLHttpRequest) return xmlhttp=new XMLHttpRequest();
        else return xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
</script>
<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script>

    var GAME_HORIZONTAL = 1000;
    var GAME_VERTICAL = 1000;
    var BALL_RADIUS = 50;

    var REAL_WIDTH = 500;
    var REAL_HEIGHT = 500;
    var REAL_RADIUS = 25;

    var players = [];

    var socket = io.connect('http://localhost:3000');
    socket.on('dataChange', function (data) {
        players = data.players;
        drawPlayers();
    });
    socket.on('collision', function (playerId) {
        console.log('collision', playerId);
    });

    var stage = circle1 = circle2 = null;

    function init() {
        stage = new createjs.Stage("demoCanvas");
    }

    function drawPlayers() {
        if (players.length === 0) {
            if (circle1) {
                stage.removeChild(circle1);
                circle1 = null;
            }
            if (circle2) {
                stage.removeChild(circle2);
                circle2 = null;
            }
            return stage.update();
        }

        if (!circle1) {
            circle1 = new createjs.Shape();
            circle1.graphics.beginFill("DeepSkyBlue").drawCircle(0, 0, 50 * REAL_RADIUS / BALL_RADIUS);
            stage.addChild(circle1);
        }

        circle1.x = players[0].position.x * REAL_WIDTH / GAME_HORIZONTAL;
        circle1.y = players[0].position.y * REAL_HEIGHT / GAME_VERTICAL;

        if (players.length === 1) {
            if (circle2) {
                stage.removeChild(circle2);
                circle2 = null;
            }
            return stage.update();
        }

        if (!circle2) {
            circle2 = new createjs.Shape();
            circle2.graphics.beginFill("red").drawCircle(0, 0, 50 * REAL_RADIUS / BALL_RADIUS);
            stage.addChild(circle2);
        }

        circle2.x = players[1].position.x * REAL_WIDTH / GAME_HORIZONTAL;
        circle2.y = players[1].position.y * REAL_HEIGHT / GAME_VERTICAL;

        stage.update();

    }


    var player = null;
    function login() {
        if (!player) {
            var http = getAjax();
            http.open('POST', 'http://localhost:3000/api/players/', true);
            http.onload = function (response) {
                player = response.currentTarget.responseText.replace(/"/g, '');
            };
            http.setRequestHeader("Content-type","application/json");
            http.send();
        }
    }

    function logout() {
        if (player) {
            var http = getAjax();
            http.open('DELETE', 'http://localhost:3000/api/players/' + player, true);
            http.setRequestHeader("Content-type","application/json");
            http.send();
            player = null;
        }
    }
</script>
</body>
</html>